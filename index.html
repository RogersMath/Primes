<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">
    <div id="start-screen" class="container mx-auto p-4 max-w-md text-center">
        <h1 class="text-4xl font-bold mb-4">Primes</h1>
        <button id="start-game" class="bg-green-500 text-white p-2 rounded w-full text-xl">Start Game</button>
    </div>

    <div id="game-container" class="container mx-auto p-4 max-w-md hidden">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">Primes</h1>
            <button id="sound-toggle" class="text-2xl"><i class="fas fa-volume-up"></i></button>
        </div>
        <div id="round-info" class="text-xl font-bold text-center mb-4"></div>
        <div id="stats" class="mb-4 text-lg">
            <div id="timer" class="mb-2">Time: 60s</div>
            <div id="primes" class="mb-2">Primes: 0</div>
            <div id="research" class="mb-2">Research: 0</div>
        </div>
        <div id="harvest-mode">
            <div id="problem" class="text-2xl font-bold mb-4"></div>
            <div id="answers" class="grid grid-cols-1 gap-2"></div>
        </div>
        <div id="research-mode" class="hidden">
            <div id="current-upgrades" class="mb-4"></div>
            <div id="discoveries" class="grid grid-cols-1 gap-2"></div>
            <button id="start-round" class="bg-blue-500 text-white p-2 rounded mt-4 w-full">Start Next Round</button>
            <button id="shard-prime" class="bg-purple-500 text-white p-2 rounded mt-2 w-full">Shard Prime</button>
        </div>
        <div id="victory-mode" class="hidden text-center">
            <h2 class="text-3xl font-bold mb-4">Victory!</h2>
            <div id="victory-stats" class="text-lg"></div>
        </div>
    </div>

    <audio id="backgroundMusic">
        <source src="backgroundMusic.mp3" type="audio/mpeg">
    </audio>
    <audio id="correctSound">
        <source src="correctSound.mp3" type="audio/mpeg">
    </audio>
    <audio id="incorrectSound">
        <source src="incorrectSound.mp3" type="audio/mpeg">
    </audio>
    <audio id="discoverySound">
        <source src="discoverySound.mp3" type="audio/mpeg">
    </audio>
    <audio id="primeHarvestSound">
        <source src="primeHarvestSound.mp3" type="audio/mpeg">
    </audio>
    <audio id="shardSound">
        <source src="shardSound.mp3" type="audio/mpeg">
    </audio>

    <script>
        const gameState = {
            primes: 0,
            research: 0,
            discoveries: {
                coreProperties: 0,
                orderOfOperations: 0,
                factoring: 0,
                modulo: 0,
                sieveOfEratosthenes: 0,
                absoluteValues: 0
            },
            currentMode: 'harvest',
            timer: 60,
            problemType: 'addition',
            round: 0,
            totalProblems: 0,
            correctProblems: 0,
            soundEnabled: true
        };

        const discoveryCosts = {
            coreProperties: [50, 250, 1250],
            orderOfOperations: [50, 250, 1250],
            factoring: [50, 250, 1250],
            modulo: [50, 250, 1250],
            sieveOfEratosthenes: [50, 250, 1250],
            absoluteValues: [50, 250, 1250]
        };

        const discoveryEffects = {
            coreProperties: 'Gain 3 additional research per correct answer',
            orderOfOperations: 'Double research gain and introduce complex problems',
            factoring: '50% chance to gain an extra prime',
            modulo: 'Gain research every second and boost Shard Prime',
            sieveOfEratosthenes: 'Automatically harvest primes periodically',
            absoluteValues: 'Harvest primes based on absolute value of answers'
        };

        function updateDisplay() {
            document.getElementById('timer').textContent = `Time: ${gameState.timer}s`;
            document.getElementById('primes').textContent = `Primes: ${gameState.primes}`;
            document.getElementById('research').textContent = `Research: ${gameState.research}`;
            document.getElementById('round-info').textContent = `Round ${gameState.round}`;
        }

        function generateProblem() {
            const a = Math.floor(Math.random() * 20) + 1;
            const b = Math.floor(Math.random() * 20) + 1;
            let problem, answer;
            
            if (Math.random() < 0.5) {
                problem = `${a} + ${b}`;
                answer = a + b;
            } else {
                problem = `${a} - ${b}`;
                answer = a - b;
            }

            if (gameState.discoveries.orderOfOperations > 0 && Math.random() < 0.1 * gameState.discoveries.orderOfOperations) {
                const c = Math.floor(Math.random() * 10) + 1;
                problem = `${a} * ${b} + ${c}`;
                answer = a * b + c;
            }

            document.getElementById('problem').textContent = problem;
            
            const answers = [answer];
            while (answers.length < 4) {
                let wrongAnswer = answer + Math.floor(Math.random() * 10) - 5;
                if (wrongAnswer !== answer && !answers.includes(wrongAnswer)) {
                    answers.push(wrongAnswer);
                }
            }
            answers.sort(() => Math.random() - 0.5);

            const answersDiv = document.getElementById('answers');
            answersDiv.innerHTML = '';
            answers.forEach(ans => {
                const button = document.createElement('button');
                button.textContent = ans;
                button.className = 'bg-zinc-500 text-white p-2 rounded w-full';
                button.onclick = () => checkAnswer(ans, answer);
                answersDiv.appendChild(button);
            });

            gameState.totalProblems++;
        }

        function checkAnswer(userAnswer, correctAnswer) {
            if (userAnswer === correctAnswer) {
                playSound('correctSound');
                let researchGain = 1;
                researchGain += gameState.discoveries.coreProperties * 3;
                if (gameState.discoveries.orderOfOperations > 0) {
                    researchGain *= 2;
                }
                gameState.research += researchGain;
                gameState.correctProblems++;
                
                if (isPrime(Math.abs(correctAnswer)) && (gameState.discoveries.absoluteValues > 0 || correctAnswer > 0)) {
                    gameState.primes += 1;
                    playSound('primeHarvestSound');
                    if (gameState.discoveries.factoring > 0 && Math.random() < 0.5) {
                        gameState.primes += 1;
                    }
                }
            } else {
                playSound('incorrectSound');
                if (gameState.research > 0) {
                    gameState.research -= 1;
                }
            }
            updateDisplay();
            generateProblem();
            checkVictory();
        }

        function isPrime(num) {
            if (num <= 1) return false;
            for (let i = 2; i <= Math.sqrt(num); i++) {
                if (num % i === 0) return false;
            }
            return true;
        }

        function startRound() {
            gameState.currentMode = 'harvest';
            gameState.timer = 60;
            gameState.round++;
            document.getElementById('harvest-mode').classList.remove('hidden');
            document.getElementById('research-mode').classList.add('hidden');
            document.getElementById('victory-mode').classList.add('hidden');
            generateProblem();
            updateDisplay();

            const timerInterval = setInterval(() => {
                gameState.timer--;
                if (gameState.discoveries.modulo > 0) {
                    gameState.research += gameState.discoveries.modulo;
                }
                if (gameState.discoveries.sieveOfEratosthenes > 0 && gameState.timer % 10 === 0) {
                    gameState.primes += gameState.discoveries.sieveOfEratosthenes;
                }
                updateDisplay();
                if (gameState.timer <= 0) {
                    clearInterval(timerInterval);
                    endRound();
                }
            }, 1000);
        }

        function endRound() {
            gameState.currentMode = 'research';
            document.getElementById('harvest-mode').classList.add('hidden');
            document.getElementById('research-mode').classList.remove('hidden');
            displayUpgrades();
            displayDiscoveries();
        }

        function displayUpgrades() {
            const upgradesDiv = document.getElementById('current-upgrades');
            upgradesDiv.innerHTML = '<h2 class="text-xl font-bold mb-2">Current Upgrades:</h2>';
            for (const [discovery, level] of Object.entries(gameState.discoveries)) {
                if (level > 0) {
                    upgradesDiv.innerHTML += `<p>${discovery} (Level ${level}): ${discoveryEffects[discovery]}</p>`;
                }
            }
        }

        function displayDiscoveries() {
            const discoveriesDiv = document.getElementById('discoveries');
            discoveriesDiv.innerHTML = '';
            for (const [discovery, level] of Object.entries(gameState.discoveries)) {
                if (level < discoveryCosts[discovery].length) {
                    const button = document.createElement('button');
                    button.textContent = `Upgrade ${discovery} (Level ${level + 1}): ${discoveryCosts[discovery][level]} research`;
                    button.className = 'bg-yellow-500 text-white p-2 rounded w-full';
                    button.onclick = () => upgradeDiscovery(discovery);
                    discoveriesDiv.appendChild(button);
                }
            }
        }

        function upgradeDiscovery(discovery) {
            const cost = discoveryCosts[discovery][gameState.discoveries[discovery]];
            if (gameState.research >= cost) {
                gameState.research -= cost;
                gameState.discoveries[discovery]++;
                playSound('discoverySound');
                updateDisplay();
                displayUpgrades();
                displayDiscoveries();
                checkVictory();
            }
        }

        function shardPrime() {
            if (gameState.primes > 0) {
                playSound('shardSound');
                gameState.primes--;
                let researchGain = 10;
                researchGain += gameState.discoveries.modulo * 5;
                gameState.research += researchGain;
                updateDisplay();
            }
        }

        function initGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            playSound('backgroundMusic', true);
            startRound();
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            const icon = document.querySelector('#sound-toggle i');
            icon.className = gameState.soundEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
            document.querySelectorAll('audio').forEach(audio => {
                audio.muted = !gameState.soundEnabled;
            });
        }

        function playSound(id, loop = false) {
            if (gameState.soundEnabled) {
                const audio = document.getElementById(id);
                audio.loop = loop;
                audio.play().catch(error => console.log("Audio play failed:", error));
            }
        }

        function checkVictory() {
            const allDiscoveriesMaxed = Object.values(gameState.discoveries).every(level => level === 3);
            if (allDiscoveriesMaxed && gameState.primes >= 100) {
                gameState.currentMode = 'victory';
                document.getElementById('harvest-mode').classList.add('hidden');
                document.getElementById('research-mode').classList.add('hidden');
                document.getElementById('victory-mode').classList.remove('hidden');
                displayVictoryStats();
            }
        }

        function displayVictoryStats() {
            const victoryStatsDiv = document.getElementById('victory-stats');
            const percentCorrect = (gameState.correctProblems / gameState.totalProblems * 100).toFixed(2);
            victoryStatsDiv.innerHTML = `
                <p>Rounds Played: ${gameState.round}</p>
                <p>Total Problems: ${gameState.totalProblems}</p>
                <p>Correct Answers: ${gameState.correctProblems}</p>
                <p>Accuracy: ${percentCorrect}%</p>
            `;
        }

        document.getElementById('start-game').onclick = initGame;
        document.getElementById('start-round').onclick = startRound;
        document.getElementById('shard-prime').onclick = shardPrime;
        document.getElementById('sound-toggle').onclick = toggleSound;
    </script>
</body>
</html>
